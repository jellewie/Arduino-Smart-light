<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
        <link rel="manifest" href="manifest.json">
        <style>
            body, html{
                font-family: Helvetica, Arial, sans-serif;
                margin: 0;
                background: var(--selected-color);
                color: var(--ui-color);
            }
            #sliders{
                width: 80%;
                max-width: 400px;
                top: 50%;
                left: 50%;
                position: absolute;
                transform: translate(-50%, -50%);
            }
            .sliderContainer{
                margin: 30px 0;
                text-align: center;
            }
            .toast{
                position: absolute;
                right: 0;
                top: 0;
                background: var(--selected-color);
                border: 1px solid var(--ui-color);
                font-size: 14pt;
                margin: 30px;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 2px 2px var(--ui-color-trans2);
                will-change: transform;
                transition: opacity 0.2s, transform 0.2s;
            }
            .toast.error{
                background: #ff5026;
            }
            .toast.hidden{
                transform: translateY(-30%);
                opacity: 0;
            }
            input[type="range"]{
                display: block;
                width: 100%;
                margin: 0;
                -webkit-appearance: none;
                background: transparent;
            }
            input[type="range"]:focus{
                outline: none;
            }
            input[type="range"]::-webkit-slider-runnable-track{
                background: var(--ui-color-trans2);
                height: 5px;
                margin: 30px 0px;
                border-radius: 5px;
            }
            @media (max-height: 540px) {
                input[type="range"]::-webkit-slider-runnable-track{
                    margin: 10px 0px;
                }
            }
            input[type="range"]:hover::-webkit-slider-runnable-track{
                background: var(--ui-color-trans1);
            }
            input[type="range"]::-webkit-slider-thumb{
                -webkit-appearance: none;
                background: var(--ui-color);
                width: 10px;
                height: 10px;
                border-radius: 30px;
                margin-top: -3px;
                transition: width 0.2s, height 0.2s, margin-top 0.2s;
            }
            input[type="range"]:hover::-webkit-slider-thumb{
                width: 30px;
                height: 30px;
                margin-top: -12.5px;
            }
            #settingsContainer{
                position: absolute;
                bottom: 0;
                padding-bottom: 20px;
                width: 100%;
                text-align: center;
            }
            .selectLabel{
                margin: 5px;
            }
            .selectContainer{
                display: inline-block;
                position: relative;
            }
            select{
                -webkit-appearance: none;
                background: none;
                color: var(--ui-color);
                border: solid 1px var(--ui-color);
                border-radius: 5px;
                margin: 3px;
                padding: 2px;
            }
            select:focus {
                outline: none;
            }
            select,
            .dropdownFakeValue {
                font-size: 11px;
            }
            .dropdownFakeValue{
                display: inline-block;
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                pointer-events: none;
            }
            option{
                color: initial;
            }
            button{
                -webkit-appearance: none;
                background: var(--ui-color);
                border: none;
                padding: 3px 5px;
                margin: 3px;
                border-radius: 5px;
                color: var(--selected-color);
            }
        </style>
        <style id="colorVars"></style>
    </head>
    <body>
        <div id="sliders"></div>
        <div id="settingsContainer"></div>
        <script>
            let slidersEl = document.getElementById("sliders");
            let settingsContainerEl = document.getElementById("settingsContainer");
            let colorVarsEl = document.getElementById("colorVars");
            class Slider {
                constructor(name, forceRgb = true) {
                    this.name = name;
                    this.containerEl = document.createElement("div");
                    this.containerEl.classList.add("sliderContainer");
                    slidersEl.appendChild(this.containerEl);
                    this.textEl = document.createElement("div");
                    this.textEl.classList.add("sliderText");
                    this.containerEl.appendChild(this.textEl);
                    this.rangeEl = document.createElement("input");
                    this.rangeEl.type = "range";
                    this.rangeEl.min = "0";
                    this.rangeEl.max = "255";
                    this.containerEl.appendChild(this.rangeEl);
                    this.rangeEl.addEventListener("input", (_) => {
                        this.update();
                    });
                    this.rangeEl.addEventListener("change", (_) => {
                        setServerState(forceRgb);
                    });
                    this.updateText();
                }
                get value() {
                    return this.rangeEl.value;
                }
                set value(v) {
                    this.rangeEl.value = v;
                    this.update();
                }
                get value01() {
                    return this.value / 255;
                }
                update() {
                    this.updateText();
                    updateCssColor();
                }
                updateText() {
                    this.textEl.textContent = this.name + ": " + this.value;
                }
            }
            class DropDown {
                constructor({ name = "", setParamName = "", possibleValues = [], modifySendParams = null } = {}) {
                    let labelEl = document.createElement("label");
                    labelEl.classList.add("selectLabel");
                    labelEl.textContent = name + ":";
                    settingsContainerEl.appendChild(labelEl);
                    this.name = name;
                    this._value = "";
                    this.setParamName = setParamName;
                    this.modifySendParams = modifySendParams;
                    let selectContainer = document.createElement("div");
                    selectContainer.classList.add("selectContainer");
                    labelEl.appendChild(selectContainer);
                    this.el = document.createElement("select");
                    selectContainer.appendChild(this.el);
                    this.el.addEventListener("change", (_) => {
                        this.onChange();
                    });
                    for (const val of possibleValues) {
                        let optionEl = document.createElement("option");
                        optionEl.value = optionEl.textContent = val;
                        this.el.appendChild(optionEl);
                    }
                    this.el.value = "";
                    this.fakeValueEl = document.createElement("div");
                    this.fakeValueEl.classList.add("dropdownFakeValue");
                    selectContainer.appendChild(this.fakeValueEl);
                }
                async onChange() {
                    this.value = this.el.value;
                    this.el.value = "";
                    let sendParams = {};
                    sendParams[this.setParamName] = this.value;
                    if (this.modifySendParams) {
                        let newSendParams = this.modifySendParams(sendParams);
                        if (newSendParams) sendParams = newSendParams;
                    }
                    let success = await sendServerState(sendParams);
                    if (success) {
                        doToastMessage(this.name + " Updated");
                    }
                }
                get value() {
                    return this._value;
                }
                set value(v) {
                    this._value = v;
                    this.fakeValueEl.textContent = v;
                }
            }
            class Button {
                constructor(label, cb) {
                    this.el = document.createElement("button");
                    this.el.textContent = label;
                    settingsContainer.appendChild(this.el);
                    this.el.addEventListener("click", (_) => {
                        cb();
                    });
                }
            }
            class RequestButton extends Button {
                constructor(label, endpoint, successMessage) {
                    super(label, async (_) => {
                        try {
                            let response = await fetch(endpoint);
                            if (response.ok) {
                                doToastMessage(successMessage);
                            } else {
                                doToastMessage(await response.body(), true);
                            }
                        } catch (_) {
                            doToastMessage("Failed to connect", true);
                        }
                    });
                }
            }
            let brightnessSlider = new Slider("Brightness", false);
            let redSlider = new Slider("Red");
            let greenSlider = new Slider("Green");
            let blueSlider = new Slider("Blue");
            let modeDropdown = new DropDown({
                name: "Mode",
                setParamName: "m",
                possibleValues: ["OFF", "ON", "WIFI", "CLOCK", "BLINK", "BPM", "CONFETTI", "FLASH", "GLITTER", "JUGGLE", "MOVE", "RAINBOW", "SINELON", "SINELON2"],
                modifySendParams: (oldParams) => {
                    if (modeDropdown.value == "WIFI") {
                        let extraData = this.getServerStateMessageData(true);
                        return { ...oldParams, ...extraData };
                    }
                },
            });
            let bootModeDropdown = new DropDown({ name: "Bootmode", setParamName: "bm", possibleValues: ["OFF", "ON", "WIFI", "CLOCK"] });
            let hourlyAnimDropdown = new DropDown({ name: "Hourly Animation", setParamName: "a", possibleValues: ["FALSE", "TRUE"] });
			let DoubleModeDropdown = new DropDown({ name: "DoublePressMode", setParamName: "dm", possibleValues: ["WIFI", "CLOCK", "BLINK", "BPM", "CONFETTI", "FLASH", "GLITTER", "JUGGLE", "MOVE", "RAINBOW", "SINELON", "SINELON2"] });
            settingsContainer.appendChild(document.createElement("br"));
            let otaBtn = new RequestButton("Enable OTA", "/ota", "OTA Enabled");
            let timeBtn = new RequestButton("Sync Time", "/time", "Time Updated");
            let resetBtn = new RequestButton("Reset", "/set?m=RESET", "ESP restarting");
            function updateCssColor() {
                let r = redSlider.value01 * brightnessSlider.value01 * 255;
                let g = greenSlider.value01 * brightnessSlider.value01 * 255;
                let b = blueSlider.value01 * brightnessSlider.value01 * 255;
                let selectedColor = `rgb(${r},${g},${b})`;
                let perceivedBrightness = Math.round((r * 299 + g * 587 + b * 114) / 1000);
                let uiBrightness = perceivedBrightness > 125 ? 0 : 255;
                let uiColRGB = uiBrightness + "," + uiBrightness + "," + uiBrightness;
                let uiColor = `rgb(${uiColRGB})`;
                let uiColorTrans1 = `rgba(${uiColRGB},0.8)`;
                let uiColorTrans2 = `rgba(${uiColRGB},0.5)`;
                colorVarsEl.textContent = `:root{--selected-color: ${selectedColor};--ui-color: ${uiColor};--ui-color-trans1: ${uiColorTrans1};--ui-color-trans2: ${uiColorTrans2};}`;
            }
            updateCssColor();
            async function getServerState() {
                let response = await fetch("/get");
                await updateServerStateFromResponse(response);
            }
            getServerState();
            setInterval(async (_) => {
                getServerState();
            }, 10 * 1000);
            function getServerStateMessageData(forceRgb = true) {
                let state = { l: brightnessSlider.value };
                if (modeDropdown.value == "WIFI" || forceRgb) {
                    state = { ...state, r: redSlider.value, g: greenSlider.value, b: blueSlider.value };
                }
                return state;
            }
            async function setServerState(forceRgb = true) {
                let state = getServerStateMessageData(forceRgb);
                await sendServerState(state);
            }
            async function sendServerState(params, endPoint = "/set") {
                let searchParams = new URLSearchParams(params);
                try {
                    let response = await fetch(endPoint + "?" + searchParams);
                    if (response.ok) {
                        await updateServerStateFromResponse(response);
                        return true;
                    } else {
                        doToastMessage(await response.body(), true);
                    }
                } catch (e) {
                    doToastMessage("Failed to connect", true);
                }
            }
            async function updateServerStateFromResponse(response) {
                if (!response.ok) return;
                let json = await response.json();
                modeDropdown.value = json.M;
                bootModeDropdown.value = json.BM;
                hourlyAnimDropdown.value = json.HA;
				DoubleModeDropdown.value = json.DM;
                let col = json.RGBL[0];
                redSlider.value = col.R;
                greenSlider.value = col.G;
                blueSlider.value = col.B;
                brightnessSlider.value = col.L;
            }
            async function timeout(ms) {
                await new Promise((r) => setTimeout(r, ms));
            }
            function recalculateStyle(elem) {
                window.getComputedStyle(elem).getPropertyValue("top");
            }
            async function doToastMessage(message, error = false) {
                let el = document.createElement("div");
                el.classList.add("toast", "hidden");
                el.classList.toggle("error", error);
                el.textContent = message;
                document.body.appendChild(el);
                recalculateStyle(el);
                el.classList.remove("hidden");
                await timeout(5000);
                el.classList.add("hidden");
                await timeout(200);
                el.parentElement.removeChild(el);
            }
            async function installSw() {
                if (!("serviceWorker" in window.navigator)) return;
                await navigator.serviceWorker.register("sw.js");
            }
            installSw();
        </script>
    </body>
</html>
